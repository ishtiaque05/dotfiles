# Dotfiles Automation Migration Plan

## Goal
Migrate from separate bash scripts (`install.sh`, `install.mac.sh`) to a unified Chezmoi-based dotfiles management system with automatic OS detection.

## Current State

### Existing Files
- `install.sh` - Linux installation script (Ubuntu/Debian-based)
- `install.mac.sh` - macOS installation script (uses Homebrew)
- `.zshrc` - Linux zsh configuration
- `.zshrc.mac` - macOS zsh configuration
- `wezterm.lua` - WezTerm configuration (shared)
- `.dircolors` - Directory colors configuration

### Current Functionality
- Package installation (OS-specific package managers)
- Zsh + Powerlevel10k theme
- Nerd Fonts installation
- WezTerm terminal emulator
- CLI tools: eza, bat, fzf, zoxide, tldr
- Zsh plugins: autosuggestions, syntax-highlighting

## Target State

### Single Command Installation
```bash
sh -c "$(curl -fsLS get.chezmoi.io)" -- init --apply syedtaqi95/dotfiles
```

### Benefits
- Auto OS detection (Linux/macOS)
- Idempotent operations (safe to re-run)
- Templating for OS-specific configs
- Easy updates and synchronization
- Better version control of changes

## Migration Strategy

### Phase 1: Setup Chezmoi Structure
- [ ] Install Chezmoi locally for testing
- [ ] Initialize Chezmoi in the dotfiles repository
- [ ] Understand Chezmoi directory structure and naming conventions

### Phase 2: Convert Configuration Files
- [ ] Convert `.zshrc` and `.zshrc.mac` to templated `.zshrc.tmpl`
  - Use `{{ if eq .chezmoi.os "darwin" }}` for macOS-specific sections
  - Use `{{ if eq .chezmoi.os "linux" }}` for Linux-specific sections
- [ ] Add `wezterm.lua` as `dot_wezterm.lua`
- [ ] Add `.dircolors` as `dot_dircolors`
- [ ] Handle any other config files

### Phase 3: Convert Installation Scripts
- [ ] Create `run_once_before_install-packages.sh.tmpl` for common dependencies
- [ ] Create `run_once_install-linux.sh.tmpl` for Linux-specific packages
  - Apt repository setup
  - Linux-specific tools
- [ ] Create `run_once_install-macos.sh.tmpl` for macOS-specific packages
  - Homebrew installation
  - macOS-specific tools
- [ ] Create `run_once_install-fonts.sh.tmpl` for Nerd Fonts (with OS-specific paths)
- [ ] Create `run_once_install-zsh-plugins.sh.tmpl` for Powerlevel10k and plugins

### Phase 4: Chezmoi Configuration
- [ ] Create `.chezmoi.toml.tmpl` with:
  - OS detection variables
  - User configuration
  - Diff tool preferences
- [ ] Create `.chezmoiignore` to exclude unnecessary files
  - Old install scripts (after migration)
  - README, LICENSE, etc.

### Phase 5: Testing
- [ ] Test on Linux VM/system
  - Fresh installation
  - Re-run (idempotency test)
  - Verify all packages installed
  - Verify all configs symlinked correctly
- [ ] Test on macOS system
  - Fresh installation
  - Re-run (idempotency test)
  - Verify Homebrew setup
  - Verify all configs correct
- [ ] Test update workflow: `chezmoi update`

### Phase 6: Documentation
- [ ] Update README.md with:
  - New installation instructions
  - Chezmoi usage guide
  - How to add new dotfiles
  - Troubleshooting section
- [ ] Add comments to template files explaining conditionals
- [ ] Document any manual steps (P10k configuration, bat themes)

### Phase 7: Cleanup
- [ ] Archive old install scripts (or remove after confirming migration works)
- [ ] Remove OS-specific config files (.zshrc.mac)
- [ ] Update git repository
- [ ] Tag release (e.g., `v2.0.0-chezmoi`)

## File Mapping

### Config Files
| Current File | Chezmoi Path | Notes |
|-------------|--------------|-------|
| `.zshrc` / `.zshrc.mac` | `dot_zshrc.tmpl` | Merge with OS conditionals |
| `wezterm.lua` | `dot_wezterm.lua` | Same for both OS |
| `.dircolors` | `dot_dircolors` | Check if OS-specific needed |
| `.p10k.zsh` (if exists) | `dot_p10k.zsh` | Generated by P10k wizard |

### Scripts
| Current Function | Chezmoi Script | Runs On |
|-----------------|----------------|---------|
| `install_homebrew` | `run_once_install-macos.sh.tmpl` | macOS only |
| `install_git_and_curl` | Both OS scripts | OS-specific |
| `install_zsh` | Both OS scripts | OS-specific |
| `setup_nerd_font` | `run_once_install-fonts.sh.tmpl` | Both (different paths) |
| `install_wezterm` | Both OS scripts | OS-specific package managers |
| `install_powerlvl10k` | `run_once_install-zsh-plugins.sh.tmpl` | Both |
| `install_zsh_autosuggestions` | `run_once_install-zsh-plugins.sh.tmpl` | Both |
| `install_zsh_syntax_highlighting` | `run_once_install-zsh-plugins.sh.tmpl` | Both |
| `install_eza` | Both OS scripts | Different package managers |
| `install_bat` | Both OS scripts | Different package names |
| `install_fzf` | Both OS scripts | Different installation methods |
| `install_zoxide` | Both OS scripts | Both |
| `install_tldr` | Both OS scripts | Both |

## Key Decisions

### 1. Template Strategy
- Use Go templating for OS-specific sections in config files
- Keep scripts separate per OS for clarity (easier than heavy templating)

### 2. Script Naming Convention
- `run_once_` prefix: Runs only once (Chezmoi tracks execution)
- `run_onchange_` prefix: Runs when script content changes
- Use `run_once_` for package installations
- Use `run_onchange_` for config updates if needed

### 3. Idempotency
- All install scripts should check if package/tool already exists
- Keep existing `command -v` and directory checks
- Safe to re-run multiple times

### 4. Package Management
- Linux: Keep apt-based installation
- macOS: Use Homebrew (could also create Brewfile for cleaner approach)
- Consider adding Brewfile for macOS in future iteration

## Rollback Plan
- Keep old scripts in `legacy/` folder temporarily
- Test thoroughly before removing old scripts
- Document manual rollback steps if needed

## Future Enhancements
- [ ] Add Brewfile for macOS package management
- [ ] Add encrypted secrets management for sensitive configs
- [ ] Add machine-specific configurations
- [ ] Add automated testing with GitHub Actions
- [ ] Add pre-commit hooks for dotfiles validation

## Timeline Estimate
- Phase 1-2: Setup and config conversion
- Phase 3: Script conversion (most work)
- Phase 4: Chezmoi configuration
- Phase 5: Testing (critical - don't skip)
- Phase 6-7: Documentation and cleanup

## Notes
- P10k configuration wizard still needs to run manually after first install
- Tokyo-night bat theme installation is manual (document in README)
- Some tools require shell restart to take effect
- Font selection in WezTerm might need manual verification
